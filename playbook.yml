---
# Ubuntu Server Setup Playbook
# Modular playbook for Ubuntu server configuration with security hardening,
# optional Docker, LEMP stack, development tools, and system optimization

# =============================================================================
# PLAY 1: Gather Connection Information
# =============================================================================
# Purpose: Prompt for server IP and SSH credentials, then dynamically add host
# This play runs locally and sets up the inventory for the main provisioning play
- name: Gather server connection information
  hosts: localhost
  connection: local
  gather_facts: false

  # NOTE: vars_prompt removed to support GUI/CLI launchers
  # All variables are now passed via -e flags from run_gui.py or run_interactive.py
  # Required variables: target_ip, target_user, ssh_key_path
  # Feature flags: prompt_enable_fail2ban, prompt_install_docker, etc.

  tasks:
    - name: Display connection information header
      debug:
        msg:
          - ""
          - "┌─────────────────────────────────────────────────────────────┐"
          - "│           CONNECTION INFORMATION                            │"
          - "└─────────────────────────────────────────────────────────────┘"

    - name: Display connection details
      debug:
        msg: "{{ item }}"
      loop:
        - "  Target Server: \033[1;36m{{ target_ip }}\033[0m"
        - "  SSH User:      \033[1;36m{{ target_user }}\033[0m"
        - "  SSH Key:       \033[1;36m{{ ssh_key_path }}\033[0m"

    - name: Display features header
      debug:
        msg:
          - ""
          - "┌─────────────────────────────────────────────────────────────┐"
          - "│           SELECTED FEATURES                                 │"
          - "└─────────────────────────────────────────────────────────────┘"

    - name: Display selected features with visual indicators
      debug:
        msg: "{{ item }}"
      loop:
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_enable_fail2ban | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Fail2ban Intrusion Prevention"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_install_docker | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Docker & Docker Compose"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_install_lemp | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} LEMP Stack (Nginx, MySQL, PHP)"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_enable_swap | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Swap Memory Configuration"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_enable_cron_jobs | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Automated Cron Jobs"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_install_dev_tools | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Development Tools"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_install_wordpress | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} WordPress CMS"
        - "  {{ '\033[1;32m✓\033[0m' if (prompt_install_certbot | lower in ['yes', 'y', 'true']) else '\033[1;31m✗\033[0m' }} Certbot SSL/TLS Certificates"
        - ""

    - name: Display feature summary
      debug:
        msg: "  \033[1;33m▸\033[0m Total features enabled: {{ feature_count }}"
      vars:
        feature_count: "{{ [prompt_enable_fail2ban, prompt_install_docker, prompt_install_lemp, prompt_enable_swap, prompt_enable_cron_jobs, prompt_install_dev_tools, prompt_install_wordpress, prompt_install_certbot] | select('match', '^(yes|y|true)$') | list | length }}"

    - name: Validate WordPress prerequisites
      fail:
        msg: "ERROR: WordPress requires LEMP stack to be installed. Please enable LEMP stack if you want to install WordPress."
      when:
        - prompt_install_wordpress | lower in ['yes', 'y', 'true']
        - prompt_install_lemp | lower not in ['yes', 'y', 'true']

    - name: Validate Certbot prerequisites
      debug:
        msg: "WARNING: Certbot works best with Nginx (LEMP stack). Ensure a web server is available."
      when:
        - prompt_install_certbot | lower in ['yes', 'y', 'true']
        - prompt_install_lemp | lower not in ['yes', 'y', 'true']

    - name: Add target server to inventory dynamically
      add_host:
        name: "{{ target_ip }}"
        groups: provisioning_target
        ansible_host: "{{ target_ip }}"
        ansible_user: "{{ target_user }}"
        ansible_ssh_private_key_file: "{{ ssh_key_path }}"
        ansible_python_interpreter: /usr/bin/python3
        # Store IP for fail2ban whitelist
        ip_address: "{{ target_ip }}"
        # Pass feature selection flags to Play 2
        enable_fail2ban: "{{ prompt_enable_fail2ban | lower in ['yes', 'y', 'true'] }}"
        install_docker: "{{ prompt_install_docker | lower in ['yes', 'y', 'true'] }}"
        install_lemp: "{{ prompt_install_lemp | lower in ['yes', 'y', 'true'] }}"
        enable_swap: "{{ prompt_enable_swap | lower in ['yes', 'y', 'true'] }}"
        enable_cron_jobs: "{{ prompt_enable_cron_jobs | lower in ['yes', 'y', 'true'] }}"
        install_dev_tools: "{{ prompt_install_dev_tools | lower in ['yes', 'y', 'true'] }}"
        install_wordpress: "{{ prompt_install_wordpress | lower in ['yes', 'y', 'true'] }}"
        install_certbot: "{{ prompt_install_certbot | lower in ['yes', 'y', 'true'] }}"

    - name: Test SSH connection to target server
      wait_for:
        host: "{{ target_ip }}"
        port: 22
        timeout: 10
      delegate_to: localhost

# =============================================================================
# PLAY 2: Main Server Provisioning
# =============================================================================
# Purpose: Complete Ubuntu server setup with all roles
- name: Ubuntu Server Setup and Configuration
  hosts: provisioning_target
  become: true
  gather_facts: true

  vars_files:
    - vars/default.yml

  pre_tasks:
    - name: Display provisioning header
      debug:
        msg:
          - ""
          - "╔═════════════════════════════════════════════════════════════╗"
          - "║         UBUNTU SERVER PROVISIONING STARTED                  ║"
          - "╚═════════════════════════════════════════════════════════════╝"
      tags:
        - always

    - name: Display target server information
      debug:
        msg:
          - "  \033[1;36m▸\033[0m Target Host:  \033[1;33m{{ inventory_hostname }}\033[0m"
          - "  \033[1;36m▸\033[0m OS:           \033[1;33m{{ ansible_distribution }} {{ ansible_distribution_version }}\033[0m"
          - "  \033[1;36m▸\033[0m Architecture: \033[1;33m{{ ansible_architecture }}\033[0m"
          - ""
      tags:
        - always

    - name: Display active features header
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────┐"
          - "│           ACTIVE FEATURES FOR THIS RUN                      │"
          - "└─────────────────────────────────────────────────────────────┘"
      tags:
        - always

    - name: Display active feature flags
      debug:
        msg: "{{ item }}"
      loop:
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (enable_fail2ban | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Fail2ban Intrusion Prevention"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (install_docker | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Docker & Docker Compose"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (install_lemp | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  LEMP Stack"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (enable_swap | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Swap Memory"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (enable_cron_jobs | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Cron Jobs"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (install_dev_tools | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Development Tools"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (install_wordpress | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  WordPress"
        - "  {{ '\033[1;32m●\033[0m \033[1;32mENABLED\033[0m' if (install_certbot | bool) else '\033[1;90m○\033[0m \033[1;90mDISABLED\033[0m' }}  Certbot"
        - ""
      tags:
        - always

    - name: Check for Docker repository conflicts
      command: grep -l "download.docker.com" /etc/apt/sources.list /etc/apt/sources.list.d/*.list
      register: docker_repo_check
      failed_when: false
      changed_when: false
      tags:
        - always

    - name: Clean Docker repository if conflicts detected
      block:
        - name: Remove any existing Docker apt key files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /etc/apt/trusted.gpg.d/docker.gpg
            - /etc/apt/keyrings/docker.gpg
            - /etc/apt/keyrings/docker.asc
            - /usr/share/keyrings/docker-archive-keyring.gpg

        - name: Find all Docker repository files
          ansible.builtin.find:
            paths: /etc/apt/sources.list.d
            patterns: "*docker*.list"
          register: docker_repo_files

        - name: Remove all Docker repository files
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: absent
          loop: "{{ docker_repo_files.files }}"

        - name: Remove Docker entries from sources.list
          ansible.builtin.lineinfile:
            path: /etc/apt/sources.list
            regexp: .*download.docker.com.*
            state: absent

        - name: Clean apt cache
          command: apt-get clean
          changed_when: false
      when: docker_repo_check.rc == 0
      tags:
        - always

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - always

    - name: Ensure fail2ban is installed (required by external role)
      ansible.builtin.apt:
        name: fail2ban
        state: present
      when: enable_fail2ban | bool
      tags:
        - always

  roles:
    # Core system setup
    - role: base_setup
      tags:
        - base
        - setup

    # Swap configuration
    - role: swap
      tags:
        - swap
        - system
      when: enable_swap | default(true) | bool

    # Security hardening
    - role: security
      tags:
        - security

    # Fail2ban intrusion prevention
    - role: oefenweb.fail2ban
      tags:
        - fail2ban
        - security
      when: enable_fail2ban | bool
      vars:
        fail2ban_services:
          - name: sshd
            port: ssh
            filter: sshd
            logpath: /var/log/auth.log
            maxretry: "{{ fail2ban_maxretry }}"
            findtime: "{{ fail2ban_findtime }}"
            bantime: "{{ fail2ban_bantime }}"
        fail2ban_ignoreips:
          - "{{ ansible_lo['ipv4']['address'] }}/8"
          - "{{ ansible_default_ipv4['address'] }}"
          - "{{ ip_address }}"

    # Docker installation (optional)
    - role: docker
      tags:
        - docker
      when: install_docker | bool

    # LEMP Stack (Linux, Nginx, MySQL, PHP) - optional
    - role: lemp
      tags:
        - lemp
        - web
      when: install_lemp | default(false) | bool

    # Automated cron jobs for maintenance
    - role: cron_jobs
      tags:
        - cron
        - automation
      when: enable_cron_jobs | default(true) | bool

    # Development tools (Neovim, Node.js, Claude Code) - optional
    - role: dev_tools
      tags:
        - dev
        - development
      when: install_dev_tools | default(false) | bool

    # WordPress deployment (requires LEMP stack) - optional
    - role: wordpress
      tags:
        - wordpress
        - web
        - cms
      when: install_wordpress | default(false) | bool

    # Certbot SSL/TLS certificate automation (requires Nginx) - optional
    - role: certbot
      tags:
        - certbot
        - ssl
        - security
      when: install_certbot | default(false) | bool

  post_tasks:
    - name: Check if reboot is required
      register: reboot_required_file
      ansible.builtin.stat:
        path: /var/run/reboot-required
      tags:
        - always

    - name: Display provisioning completion header
      ansible.builtin.debug:
        msg:
          - ""
          - "╔═════════════════════════════════════════════════════════════╗"
          - "║         PROVISIONING COMPLETED SUCCESSFULLY                 ║"
          - "╚═════════════════════════════════════════════════════════════╝"
      tags:
        - always

    - name: Display reboot requirement status
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop:
        - "{{ '\033[1;33m⚠\033[0m  \033[1;33mWARNING:\033[0m Reboot is REQUIRED (kernel or system updates)' if reboot_required_file.stat.exists else '\033[1;32m✓\033[0m  System Status: \033[1;32mNo reboot required\033[0m' }}"
        - "{{ '  \033[1;36m▸\033[0m Run with tag \033[1;36m-t reboot\033[0m to reboot now' if reboot_required_file.stat.exists else '' }}"
      when: item != ""
      tags:
        - always

    - name: Reboot the server if required
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible due to kernel updates"
        reboot_timeout: 300
        post_reboot_delay: 30
      when: reboot_required_file.stat.exists
      tags:
        - never
        - reboot
