---
# Ubuntu Server Setup Playbook
# Modular playbook for Ubuntu server configuration with security hardening,
# optional Docker, LEMP stack, development tools, and system optimization

# =============================================================================
# PLAY 1: Gather Connection Information
# =============================================================================
# Purpose: Prompt for server IP and SSH credentials, then dynamically add host
# This play runs locally and sets up the inventory for the main provisioning play
- name: Gather server connection information
  hosts: localhost
  connection: local
  gather_facts: false

  # NOTE: vars_prompt removed to support GUI launcher
  # All variables are now passed via -e flags from the Tauri GUI or command line
  # Required variables: target_ip, target_user, ssh_key_path
  # Feature flags: prompt_enable_fail2ban, prompt_install_docker, etc.

  tasks:
    - name: Display welcome banner
      debug:
        msg:
          - ""
          - "\033[1;36mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
          - "\033[1;36mâ•‘                                                               â•‘\033[0m"
          - "\033[1;36mâ•‘      ðŸš€  UBUNTU SERVER PROVISIONING PLAYBOOK  ðŸš€             â•‘\033[0m"
          - "\033[1;36mâ•‘                                                               â•‘\033[0m"
          - "\033[1;36mâ•‘   Automated Setup Â· Security Hardening Â· Modern Tools        â•‘\033[0m"
          - "\033[1;36mâ•‘                                                               â•‘\033[0m"
          - "\033[1;36mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
          - ""

    - name: Display connection information header
      debug:
        msg:
          - ""
          - "\033[1;33mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\033[0m"
          - "\033[1;33mâ”‚           ðŸ“¡ CONNECTION INFORMATION                         â”‚\033[0m"
          - "\033[1;33mâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[0m"

    - name: Display connection details
      debug:
        msg: "{{ item }}"
      loop:
        - "  Target Server: \033[1;36m{{ target_ip }}\033[0m"
        - "  SSH User:      \033[1;36m{{ target_user }}\033[0m"
        - "  SSH Key:       \033[1;36m{{ ssh_key_path }}\033[0m"

    - name: Display features header
      debug:
        msg:
          - ""
          - "\033[1;35mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\033[0m"
          - "\033[1;35mâ”‚           ðŸ“¦ SELECTED FEATURES                              â”‚\033[0m"
          - "\033[1;35mâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[0m"

    - name: Display selected features with visual indicators
      debug:
        msg: "{{ item }}"
      loop:
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_create_user | default('yes') | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Create Admin User ({{ added_user | default('organic') }})"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_enable_fail2ban | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Fail2ban Intrusion Prevention"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_docker | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Docker & Docker Compose"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_lemp | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} LEMP Stack (Nginx, MySQL, PHP)"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_enable_swap | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Swap Memory Configuration"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_enable_cron_jobs | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Automated Cron Jobs"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_dev_tools | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Development Tools"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_wordpress | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} WordPress CMS"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_certbot | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Certbot SSL/TLS Certificates"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_gemini | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Gemini AI CLI"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_kiro | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Kiro Tool"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_github_cli | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} GitHub CLI"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_btop | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} btop Monitor"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_tldr | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} tldr Pages"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_lazygit | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} lazygit TUI"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_tmux | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} tmux Multiplexer"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_zsh | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} Zsh Shell"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_ripgrep | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} ripgrep Utility"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_uv | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} uv Python PM"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_fzf | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} fzf Finder"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_bat | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} bat Cat"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_eza | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} eza Ls"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_jq | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} jq Processor"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_autossh | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} autossh Persistence"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_starship | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} starship Prompt"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_direnv | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} direnv Switcher"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_micro | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} micro Editor"
        - "  {{ '\033[1;32mâœ“\033[0m' if (prompt_install_ranger | lower in ['yes', 'y', 'true']) else '\033[1;31mâœ—\033[0m' }} ranger Manager"
        - ""

    - name: Display feature summary
      debug:
        msg: "  \033[1;33mâ–¸\033[0m Total features enabled: {{ feature_count }}"
      vars:
        feature_count: "{{ [prompt_create_user | default('yes'), prompt_enable_fail2ban, prompt_install_docker, prompt_install_lemp, prompt_enable_swap, prompt_enable_cron_jobs, prompt_install_dev_tools, prompt_install_wordpress, prompt_install_certbot, prompt_install_gemini, prompt_install_kiro, prompt_install_github_cli, prompt_install_btop, prompt_install_tldr, prompt_install_lazygit, prompt_install_tmux, prompt_install_zsh, prompt_install_ripgrep, prompt_install_uv, prompt_install_fzf, prompt_install_bat, prompt_install_eza, prompt_install_zoxide, prompt_install_jq, prompt_install_htop, prompt_install_gping, prompt_install_nmap, prompt_install_autossh, prompt_install_starship, prompt_install_direnv, prompt_install_fish, prompt_install_micro, prompt_install_ranger] | select('match', '^(yes|y|true)$') | list | length }}"

    - name: Validate WordPress prerequisites
      fail:
        msg: "\033[1;31mâŒ ERROR:\033[0m WordPress requires LEMP stack to be installed. Please enable LEMP stack if you want to install WordPress."
      when:
        - prompt_install_wordpress | lower in ['yes', 'y', 'true']
        - prompt_install_lemp | lower not in ['yes', 'y', 'true']

    - name: Validate Certbot prerequisites
      debug:
        msg: "\033[1;33mâš ï¸  WARNING:\033[0m Certbot works best with Nginx (LEMP stack). Ensure a web server is available."
      when:
        - prompt_install_certbot | lower in ['yes', 'y', 'true']
        - prompt_install_lemp | lower not in ['yes', 'y', 'true']

    - name: Add target server to inventory dynamically
      add_host:
        name: "{{ target_ip }}"
        groups: provisioning_target
        ansible_host: "{{ target_ip }}"
        ansible_user: "{{ target_user }}"
        ansible_password: "{{ connection_password | default(omit) }}"
        ansible_ssh_private_key_file: "{{ ssh_key_path }}"
        ansible_python_interpreter: /usr/bin/python3
        # Store IP for fail2ban whitelist
        ip_address: "{{ target_ip }}"
        # Store hostname for server configuration
        server_hostname: "{{ target_hostname | default('') }}"
        # Pass feature selection flags to Play 2
        create_user: "{{ prompt_create_user | default('yes') | lower in ['yes', 'y', 'true'] }}"
        enable_fail2ban: "{{ prompt_enable_fail2ban | lower in ['yes', 'y', 'true'] }}"
        install_docker: "{{ prompt_install_docker | lower in ['yes', 'y', 'true'] }}"
        install_lemp: "{{ prompt_install_lemp | lower in ['yes', 'y', 'true'] }}"
        enable_swap: "{{ prompt_enable_swap | lower in ['yes', 'y', 'true'] }}"
        enable_cron_jobs: "{{ prompt_enable_cron_jobs | lower in ['yes', 'y', 'true'] }}"
        install_dev_tools: "{{ prompt_install_dev_tools | lower in ['yes', 'y', 'true'] }}"
        install_wordpress: "{{ prompt_install_wordpress | lower in ['yes', 'y', 'true'] }}"
        install_certbot: "{{ prompt_install_certbot | lower in ['yes', 'y', 'true'] }}"
        install_gemini: "{{ prompt_install_gemini | lower in ['yes', 'y', 'true'] }}"
        install_kiro: "{{ prompt_install_kiro | lower in ['yes', 'y', 'true'] }}"
        install_github_cli: "{{ prompt_install_github_cli | lower in ['yes', 'y', 'true'] }}"
        install_btop: "{{ prompt_install_btop | lower in ['yes', 'y', 'true'] }}"
        install_tldr: "{{ prompt_install_tldr | lower in ['yes', 'y', 'true'] }}"
        install_lazygit: "{{ prompt_install_lazygit | lower in ['yes', 'y', 'true'] }}"
        install_tmux: "{{ prompt_install_tmux | lower in ['yes', 'y', 'true'] }}"
        install_zsh: "{{ prompt_install_zsh | lower in ['yes', 'y', 'true'] }}"
        install_ripgrep: "{{ prompt_install_ripgrep | lower in ['yes', 'y', 'true'] }}"
        install_fd: "{{ prompt_install_fd | lower in ['yes', 'y', 'true'] }}"
        install_duf: "{{ prompt_install_duf | lower in ['yes', 'y', 'true'] }}"
        install_ncdu: "{{ prompt_install_ncdu | lower in ['yes', 'y', 'true'] }}"
        install_lnav: "{{ prompt_install_lnav | lower in ['yes', 'y', 'true'] }}"
        install_uv: "{{ prompt_install_uv | lower in ['yes', 'y', 'true'] }}"
        install_fzf: "{{ prompt_install_fzf | lower in ['yes', 'y', 'true'] }}"
        install_bat: "{{ prompt_install_bat | lower in ['yes', 'y', 'true'] }}"
        install_eza: "{{ prompt_install_eza | lower in ['yes', 'y', 'true'] }}"
        install_zoxide: "{{ prompt_install_zoxide | lower in ['yes', 'y', 'true'] }}"
        install_jq: "{{ prompt_install_jq | lower in ['yes', 'y', 'true'] }}"
        install_htop: "{{ prompt_install_htop | lower in ['yes', 'y', 'true'] }}"
        install_gping: "{{ prompt_install_gping | lower in ['yes', 'y', 'true'] }}"
        install_nmap: "{{ prompt_install_nmap | lower in ['yes', 'y', 'true'] }}"
        install_autossh: "{{ prompt_install_autossh | lower in ['yes', 'y', 'true'] }}"
        install_starship: "{{ prompt_install_starship | lower in ['yes', 'y', 'true'] }}"
        install_direnv: "{{ prompt_install_direnv | lower in ['yes', 'y', 'true'] }}"
        install_fish: "{{ prompt_install_fish | lower in ['yes', 'y', 'true'] }}"
        install_micro: "{{ prompt_install_micro | lower in ['yes', 'y', 'true'] }}"
        install_ranger: "{{ prompt_install_ranger | lower in ['yes', 'y', 'true'] }}"
        enable_periodic_reboot: "{{ prompt_enable_periodic_reboot | lower in ['yes', 'y', 'true'] }}"
        cron_reboot_hour: "{{ prompt_reboot_hour | default('3') }}"

    - name: Test SSH connection to target server
      wait_for:
        host: "{{ target_ip }}"
        port: 22
        timeout: 10
      delegate_to: localhost

# =============================================================================
# PLAY 2: Main Server Provisioning
# =============================================================================
# Purpose: Complete Ubuntu server setup with all roles
- name: Ubuntu Server Setup and Configuration
  hosts: provisioning_target
  become: true
  gather_facts: true
  gather_subset:
    - hardware
    - network
    - '!ohai'
    - '!facter'

  vars_files:
    - vars/default.yml

  pre_tasks:
    - name: Display provisioning header
      debug:
        msg:
          - ""
          - "\033[1;32mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
          - "\033[1;32mâ•‘                                                             â•‘\033[0m"
          - "\033[1;32mâ•‘         ðŸŽ¯  UBUNTU SERVER PROVISIONING STARTED  ðŸŽ¯         â•‘\033[0m"
          - "\033[1;32mâ•‘                                                             â•‘\033[0m"
          - "\033[1;32mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
          - ""
      tags:
        - always

    - name: Display target server information
      debug:
        msg:
          - "  \033[1;36mâ–¸\033[0m Target Host:  \033[1;33m{{ inventory_hostname }}\033[0m"
          - "  \033[1;36mâ–¸\033[0m OS:           \033[1;33m{{ ansible_distribution }} {{ ansible_distribution_version }}\033[0m"
          - "  \033[1;36mâ–¸\033[0m Architecture: \033[1;33m{{ ansible_architecture }}\033[0m"
          - ""
      tags:
        - always

    - name: Display active features header
      debug:
        msg:
          - ""
          - "\033[1;35mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\033[0m"
          - "\033[1;35mâ”‚           âš¡ ACTIVE FEATURES FOR THIS RUN                   â”‚\033[0m"
          - "\033[1;35mâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[0m"
      tags:
        - always

    - name: Display active feature flags
      debug:
        msg: "{{ item }}"
      loop:
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (create_user | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Create Admin User"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (enable_fail2ban | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Fail2ban Intrusion Prevention"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (install_docker | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Docker & Docker Compose"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (install_lemp | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  LEMP Stack"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (enable_swap | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Swap Memory"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (enable_cron_jobs | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Cron Jobs"
        - "  {{ '\033[1;32mâ—\033[0m \033[1;32mENABLED\033[0m' if (install_dev_tools | bool) else '\033[1;90mâ—‹\033[0m \033[1;90mDISABLED\033[0m' }}  Development Tools"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_wordpress | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  WordPress"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_certbot | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  Certbot"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_gemini | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  Gemini AI CLI"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_kiro | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  Kiro Tool"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_github_cli | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  GitHub CLI"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_btop | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  btop Monitor"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_tldr | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  tldr Pages"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_lazygit | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  lazygit TUI"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_tmux | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  tmux Multiplexer"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_zsh | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  Zsh Shell"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_ripgrep | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  ripgrep"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_uv | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  uv Python PM"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_fzf | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  fzf Finder"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_bat | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  bat Cat"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_eza | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  eza Ls"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_autossh | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  autossh"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_starship | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  starship"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_direnv | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  direnv"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_micro | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  micro"
        - "  {{ '\033[1;32mâ—\033[1;32m ENABLED\033[0m' if (install_ranger | bool) else '\033[1;90mâ—‹\033[1;90m DISABLED\033[0m' }}  ranger"
        - ""
      tags:
        - always

    - name: Display swap memory planning (when enabled)
      block:
        - name: Calculate planned swap size
          ansible.builtin.set_fact:
            mem_total_gb_pretask: "{{ (ansible_memtotal_mb | int) // 1024 }}"

        - name: Set planned swap size
          ansible.builtin.set_fact:
            planned_swap_gb: >-
              {{
                (mem_total_gb_pretask | int * 2) if (mem_total_gb_pretask | int) < 2 else
                (mem_total_gb_pretask | int * 1.5) | round(0) | int if (mem_total_gb_pretask | int) < 4 else
                (mem_total_gb_pretask | int) if (mem_total_gb_pretask | int) < 8 else
                (mem_total_gb_pretask | int)
              }}

        - name: Display memory and swap planning information
          debug:
            msg:
              - "  System RAM: {{ mem_total_gb_pretask }} GB | Planned Swap: {{ planned_swap_gb }} GB"
      when: enable_swap | bool
      tags:
        - always

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - always

    - name: Ensure fail2ban is installed (required by external role)
      ansible.builtin.apt:
        name: fail2ban
        state: present
      when: enable_fail2ban | bool
      tags:
        - always

  roles:
    # Core system setup
    - role: base_setup
      tags:
        - base
        - setup

    # Swap configuration
    - role: swap
      tags:
        - swap
        - system
      when: enable_swap | default(true) | bool

    # Security hardening
    - role: security
      tags:
        - security

    # Fail2ban intrusion prevention
    - role: oefenweb.fail2ban
      tags:
        - fail2ban
        - security
      when: enable_fail2ban | bool
      vars:
        fail2ban_services:
          - name: sshd
            port: ssh
            filter: sshd
            logpath: /var/log/auth.log
            maxretry: "{{ fail2ban_maxretry }}"
            findtime: "{{ fail2ban_findtime }}"
            bantime: "{{ fail2ban_bantime }}"
        fail2ban_ignoreips:
          - "{{ ansible_lo['ipv4']['address'] }}/8"
          - "{{ ansible_default_ipv4['address'] }}"
          - "{{ ip_address }}"

    # Docker installation (optional)
    - role: docker
      tags:
        - docker
      when: install_docker | bool

    # LEMP Stack (Linux, Nginx, MySQL, PHP) - optional
    - role: lemp
      tags:
        - lemp
        - web
      when: install_lemp | default(false) | bool

    # Automated cron jobs for maintenance
    - role: cron_jobs
      tags:
        - cron
        - automation
      when: enable_cron_jobs | default(true) | bool

    # Development tools (Neovim, Node.js, Claude Code) - optional
    - role: dev_tools
      tags:
        - dev
        - development
      when: install_dev_tools | default(false) | bool

    # WordPress deployment (requires LEMP stack) - optional
    - role: wordpress
      tags:
        - wordpress
        - web
        - cms
      when: install_wordpress | default(false) | bool

    # Certbot SSL/TLS certificate automation (requires Nginx) - optional
    - role: certbot
      tags:
        - certbot
        - ssl
        - security
      when: install_certbot | default(false) | bool

  post_tasks:
    - name: Check if reboot is required
      register: reboot_required_file
      ansible.builtin.stat:
        path: /var/run/reboot-required
      tags:
        - always

    - name: Display provisioning completion header
      ansible.builtin.debug:
        msg:
          - ""
          - "\033[1;32mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
          - "\033[1;32mâ•‘                                                             â•‘\033[0m"
          - "\033[1;32mâ•‘      âœ…  PROVISIONING COMPLETED SUCCESSFULLY  âœ…           â•‘\033[0m"
          - "\033[1;32mâ•‘                                                             â•‘\033[0m"
          - "\033[1;32mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
          - ""
      tags:
        - always

    - name: Display reboot requirement status
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop:
        - "{{ '\033[1;33mâš \033[0m  \033[1;33mWARNING:\033[0m Reboot is REQUIRED (kernel or system updates)' if reboot_required_file.stat.exists else '\033[1;32mâœ“\033[0m  System Status: \033[1;32mNo reboot required\033[0m' }}"
        - "{{ '  \033[1;36mâ–¸\033[0m Run with tag \033[1;36m-t reboot\033[0m to reboot now' if reboot_required_file.stat.exists else '' }}"
      when: item != ""
      tags:
        - always

    - name: Reboot the server if required
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible due to kernel updates"
        reboot_timeout: 300
        post_reboot_delay: 30
      when: reboot_required_file.stat.exists
      tags:
        - never
        - reboot
