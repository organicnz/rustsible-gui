#!/bin/bash
# Automated System Backup Script
# Generated by Ansible

BACKUP_DEST="{{ backup_destination }}"
BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="${BACKUP_DEST}/${BACKUP_DATE}"
RETENTION_DAYS={{ backup_retention_days }}

# Create backup directory
mkdir -p "${BACKUP_DIR}"

# Backup directories
{% for dir in backup_directories %}
if [ -d "{{ dir }}" ]; then
    echo "Backing up {{ dir }}..."
    rsync -avz "{{ dir }}" "${BACKUP_DIR}/" 2>&1
fi
{% endfor %}

{% if backup_mysql %}
# Backup MySQL databases
if command -v mysqldump &> /dev/null; then
    echo "Backing up MySQL databases..."
    mysqldump --all-databases --single-transaction > "${BACKUP_DIR}/mysql_backup.sql" 2>&1
fi
{% endif %}

# Create tarball
cd "${BACKUP_DEST}"
tar -czf "${BACKUP_DATE}.tar.gz" "${BACKUP_DATE}" 2>&1
rm -rf "${BACKUP_DATE}"

# Remove old backups
find "${BACKUP_DEST}" -name "*.tar.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup completed: ${BACKUP_DATE}.tar.gz"
