# =============================================================================
# FAIL2BAN INTELLIGENT CONFIGURATION
# =============================================================================
# Smart intrusion prevention with adaptive bans, multiple service protection,
# and recidive jail for repeat offenders

[DEFAULT]
# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
# Ban duration: {{ fail2ban_bantime }} seconds (24 hours)
bantime = {{ fail2ban_bantime }}

# Time window for counting failures: {{ fail2ban_findtime }} seconds (10 minutes)
findtime = {{ fail2ban_findtime }}

# Maximum failures before ban: {{ fail2ban_maxretry }}
maxretry = {{ fail2ban_maxretry }}

# Backend: systemd journal is more efficient than polling log files
backend = systemd

# -----------------------------------------------------------------------------
# Email Notifications (Configure SMTP for production)
# -----------------------------------------------------------------------------
destemail = root@localhost
sendername = Fail2Ban Security Alert
mta = sendmail
# Action with email notification including relevant log lines
action = %(action_mwl)s

# -----------------------------------------------------------------------------
# Whitelist (Never ban these IPs)
# -----------------------------------------------------------------------------
# Localhost, server IP, and control machine IP
ignoreip = 127.0.0.1/8 ::1 {{ ansible_default_ipv4.address }} {{ address }}

# -----------------------------------------------------------------------------
# Ban Action Configuration
# -----------------------------------------------------------------------------
# Use iptables-multiport for better performance with multiple ports
banaction = iptables-multiport
banaction_allports = iptables-allports

# =============================================================================
# SECTION 1: SSH Protection (Critical)
# =============================================================================
# Protects SSH service from brute-force attacks and DDoS attempts

[sshd]
enabled = true
port = {{ ssh_port }}
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
# Ban for 24 hours on 3 failed attempts within 10 minutes
bantime = {{ fail2ban_bantime }}
findtime = {{ fail2ban_findtime }}

[sshd-ddos]
enabled = true
port = {{ ssh_port }}
filter = sshd-ddos
logpath = /var/log/auth.log
# More lenient for DDoS detection to avoid false positives
maxretry = 6
bantime = {{ fail2ban_bantime }}
findtime = {{ fail2ban_findtime }}

[sshd-aggressive]
# Catches aggressive SSH attacks (many connections in short time)
enabled = true
port = {{ ssh_port }}
filter = sshd-aggressive
logpath = /var/log/auth.log
maxretry = 4
bantime = {{ fail2ban_bantime }}
findtime = 60

# =============================================================================
# SECTION 2: Recidive Jail (Repeat Offender Protection)
# =============================================================================
# Bans IPs that have been banned multiple times - VERY LONG BAN

[recidive]
enabled = true
# Bans IPs that get banned 3+ times
maxretry = 3
# Look back 7 days for previous bans
findtime = 604800
# Ban repeat offenders for 1 week
bantime = 604800
filter = recidive
logpath = /var/log/fail2ban.log
action = %(action_mwl)s

[recidive-longterm]
# Ultra-long ban for persistent attackers
enabled = true
maxretry = 5
# Look back 30 days
findtime = 2592000
# Ban for 30 days
bantime = 2592000
filter = recidive
logpath = /var/log/fail2ban.log

# =============================================================================
# SECTION 3: Web Server Protection (Nginx/Apache)
# =============================================================================
# Protects web servers from various attacks

[nginx-http-auth]
# Failed HTTP authentication attempts
enabled = true
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-noscript]
# Blocks script kiddies looking for scripts on your site
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6
bantime = 3600

[nginx-badbots]
# Bans bad bots and crawlers
enabled = true
port = http,https
filter = nginx-badbots
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

[nginx-noproxy]
# Blocks proxy attempts
enabled = true
port = http,https
filter = nginx-noproxy
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

[nginx-limit-req]
# Rate limiting violations
enabled = true
port = http,https
filter = nginx-limit-req
logpath = /var/log/nginx/error.log
maxretry = 10
findtime = 60
bantime = 7200

[nginx-botsearch]
# Blocks bots searching for vulnerabilities
enabled = true
port = http,https
filter = nginx-botsearch
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

# =============================================================================
# SECTION 4: Apache Protection (if Apache is installed)
# =============================================================================

[apache-auth]
enabled = false
port = http,https
filter = apache-auth
logpath = /var/log/apache*/*error.log
maxretry = 3
bantime = 3600

[apache-badbots]
enabled = false
port = http,https
filter = apache-badbots
logpath = /var/log/apache*/*access.log
maxretry = 2
bantime = 86400

[apache-noscript]
enabled = false
port = http,https
filter = apache-noscript
logpath = /var/log/apache*/*error.log
maxretry = 6
bantime = 3600

[apache-overflows]
enabled = false
port = http,https
filter = apache-overflows
logpath = /var/log/apache*/*error.log
maxretry = 2
bantime = 86400

[apache-nohome]
enabled = false
port = http,https
filter = apache-nohome
logpath = /var/log/apache*/*error.log
maxretry = 2
bantime = 86400

[apache-botsearch]
enabled = false
port = http,https
filter = apache-botsearch
logpath = /var/log/apache*/*error.log
maxretry = 2
bantime = 86400

# =============================================================================
# SECTION 5: PHP & Application Protection
# =============================================================================

[php-url-fopen]
# Blocks PHP code injection attempts
enabled = true
port = http,https
filter = php-url-fopen
logpath = /var/log/nginx/access.log
          /var/log/apache*/*access.log
maxretry = 2
bantime = 86400

[wordpress]
# WordPress brute force protection
enabled = false
port = http,https
filter = wordpress
logpath = /var/log/nginx/access.log
          /var/log/apache*/*access.log
maxretry = 3
findtime = 300
bantime = 3600

# =============================================================================
# SECTION 6: Mail Server Protection (Postfix/Dovecot)
# =============================================================================

[postfix]
enabled = false
port = smtp,465,submission
filter = postfix
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[postfix-sasl]
enabled = false
port = smtp,465,submission,imap,imaps,pop3,pop3s
filter = postfix-sasl
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[dovecot]
enabled = false
port = pop3,pop3s,imap,imaps,submission,465,sieve
filter = dovecot
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

# =============================================================================
# SECTION 7: Database Protection
# =============================================================================

[mysql-auth]
# MySQL authentication failures
enabled = false
port = 3306
filter = mysql-auth
logpath = /var/log/mysql/error.log
maxretry = 3
bantime = 3600

[mysql-probe]
# Detects MySQL port scanning
enabled = false
port = 3306
filter = mysql-probe
logpath = /var/log/mysql/error.log
maxretry = 2
bantime = 86400

# =============================================================================
# SECTION 8: FTP Protection
# =============================================================================

[vsftpd]
enabled = false
port = ftp,ftp-data,ftps,ftps-data
filter = vsftpd
logpath = /var/log/vsftpd.log
maxretry = 3
bantime = 3600

[proftpd]
enabled = false
port = ftp,ftp-data,ftps,ftps-data
filter = proftpd
logpath = /var/log/proftpd/proftpd.log
maxretry = 3
bantime = 3600

# =============================================================================
# SECTION 9: DNS & Network Services
# =============================================================================

[named-refused]
# BIND DNS server
enabled = false
port = domain,953
filter = named-refused
logpath = /var/log/named/security.log
maxretry = 10
bantime = 3600

# =============================================================================
# SECTION 10: Denial of Service Protection
# =============================================================================

[http-get-dos]
# HTTP GET flood protection
# WARNING: May cause false positives on high-traffic sites
enabled = false
port = http,https
filter = http-get-dos
logpath = /var/log/nginx/access.log
          /var/log/apache*/*access.log
# 300 requests in 5 minutes = ban
maxretry = 300
findtime = 300
# Ban for 10 minutes
bantime = 600

[http-post-dos]
# HTTP POST flood protection
enabled = false
port = http,https
filter = http-post-dos
logpath = /var/log/nginx/access.log
          /var/log/apache*/*access.log
maxretry = 100
findtime = 300
bantime = 600

# =============================================================================
# SECTION 11: Port Scanning Detection
# =============================================================================

[port-scan]
# Detects and bans port scanners
enabled = true
filter = port-scan
logpath = /var/log/syslog
maxretry = 5
bantime = 86400

# =============================================================================
# SECTION 12: Pam Generic Protection
# =============================================================================

[pam-generic]
# Catches authentication failures in various PAM services
enabled = true
filter = pam-generic
logpath = /var/log/auth.log
maxretry = 5
bantime = 3600

# =============================================================================
# SECTION 13: Sudo Authentication Failures
# =============================================================================

[sudo]
# Catches sudo authentication failures
enabled = true
filter = sudo
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

# =============================================================================
# END OF CONFIGURATION
# =============================================================================
# Additional jails can be added as needed for specific services
# Enable/disable jails by setting enabled = true/false 