---
# =============================================================================
# SECURITY HARDENING ROLE
# =============================================================================
# Purpose: Implement comprehensive security measures including SSH hardening,
#          firewall configuration, fail2ban setup, and system hardening
#
# Selectable Tags:
#   - ssh           : SSH service hardening and configuration
#   - ssh-port      : SSH port changes only
#   - ssh-auth      : Authentication method changes (password/keys)
#   - firewall      : UFW firewall configuration
#   - ufw           : UFW-specific tasks
#   - fail2ban      : Fail2ban intrusion prevention
#   - hardening     : System hardening (PAM, permissions, etc.)
#   - pam           : PAM password policy configuration
#   - permissions   : File and directory permission hardening
#   - ddos          : DDOS protection (optional, disabled by default)
# =============================================================================

# -----------------------------------------------------------------------------
# SECTION 1: SSH Hardening
# -----------------------------------------------------------------------------
# Hardens SSH service to prevent unauthorized access and reduce attack surface.
# Implements security best practices: key-based auth, no root login, non-standard port.

- name: "SSH Security | Configure SSH daemon for maximum security"
  block:
    - name: "SSH Auth | Disable password authentication"
      # Forces SSH key-based authentication only.
      # Prevents brute-force password attacks and credential stuffing.
      # Only applies if password_authentication is set to false in vars.
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        state: present
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
      when: not password_authentication
      notify: restart ssh
      tags:
        - ssh-auth
        - password-disable

    - name: "SSH Access | Disable root login via SSH"
      # Prevents direct root access over SSH.
      # Enforces use of non-privileged accounts with sudo for auditability.
      # Only applies if disable_root_login is true in vars.
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        state: present
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
      when: disable_root_login
      notify: restart ssh
      tags:
        - ssh-auth
        - root-disable

    - name: "SSH Port | Change SSH port to {{ ssh_port }}"
      # Changes SSH to non-standard port to reduce automated attack attempts.
      # Security through obscurity - reduces noise but not a primary defense.
      # Only applies if ssh_port is not 22 (default).
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        state: present
        regexp: '^#?Port '
        line: 'Port {{ ssh_port }}'
      when: ssh_port != 22
      notify: restart ssh
      tags:
        - ssh-port
  tags:
    - security
    - ssh
    - ssh-hardening

# -----------------------------------------------------------------------------
# SECTION 2: Firewall Configuration (UFW)
# -----------------------------------------------------------------------------
# Configures Uncomplicated Firewall (UFW) with default-deny policy.
# Only explicitly allowed services can receive incoming connections.

- name: "Firewall | Configure UFW with default-deny policy"
  block:
    - name: "Firewall | Allow SSH on port {{ ssh_port }}"
      # Must allow SSH before enabling firewall to prevent lockout.
      # Uses the ssh_port variable to handle non-standard ports.
      community.general.ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
      tags:
        - ssh-allow

    - name: "Firewall | Allow additional configured ports"
      # Opens ports defined in ufw_allowed_ports variable (vars/default.yml).
      # Each entry specifies port number and protocol (tcp/udp).
      # Common examples: 80/tcp (HTTP), 443/tcp (HTTPS), 3306/tcp (MySQL)
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop: "{{ ufw_allowed_ports }}"
      tags:
        - custom-ports

    - name: "Firewall | Enable UFW with deny-by-default incoming policy"
      # Activates firewall with restrictive default policy.
      # All incoming traffic is denied unless explicitly allowed above.
      # Outgoing traffic is allowed by default for system updates and services.
      community.general.ufw:
        state: enabled
        policy: deny
        direction: incoming
      tags:
        - enable-firewall
  tags:
    - security
    - firewall
    - ufw

# -----------------------------------------------------------------------------
# SECTION 3: Fail2ban Configuration
# -----------------------------------------------------------------------------
# Deploys custom fail2ban configuration for intrusion prevention.
# Bans IPs that show malicious signs (repeated failed login attempts, etc.).

- name: "Fail2ban | Deploy custom jail.local configuration"
  # Applies site-specific fail2ban settings from template.
  # Complements the oefenweb.fail2ban role with custom rules.
  # Template should be at roles/security/templates/jail.local.j2
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban
  tags:
    - security
    - fail2ban
    - jail-config

# -----------------------------------------------------------------------------
# SECTION 4: System Hardening
# -----------------------------------------------------------------------------
# Applies operating system-level security controls.
# Includes password policies, file permissions, and kernel parameters.

- name: "System Hardening | Apply OS-level security controls"
  block:
    - name: "PAM Security | Enforce strong password policies"
      # Configures PAM (Pluggable Authentication Modules) for password strength.
      # Requirements: 12 char minimum, 3 character difference from old password, 3 retries.
      # Note: Requires libpam-cracklib or libpam-pwquality package.
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-password
        line: "password requisite pam_cracklib.so retry=3 minlen=12 difok=3"
        state: present
      tags:
        - pam
        - password-policy

    - name: "File Permissions | Restrict access to cron directories"
      # Sets restrictive permissions (700) on cron directories.
      # Prevents unauthorized users from viewing or modifying scheduled tasks.
      # Critical for preventing privilege escalation via cron jobs.
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
        owner: root
        group: root
      loop:
        - /etc/cron.d
        - /etc/cron.daily
        - /etc/cron.hourly
        - /etc/cron.monthly
        - /etc/cron.weekly
      tags:
        - permissions
        - cron-security
  rescue:
    - name: "Error Handler | Log system hardening failure"
      ansible.builtin.debug:
        msg: "System hardening failed - please review errors above and fix manually"
  tags:
    - security
    - hardening
    - system-hardening

# -----------------------------------------------------------------------------
# SECTION 5: DDOS Protection (Optional)
# -----------------------------------------------------------------------------
# Provides basic HTTP GET flood protection using fail2ban.
# DISABLED BY DEFAULT - Enable only on web servers facing the internet.

- name: "DDOS Protection | Configure HTTP flood protection"
  block:
    - name: "Fail2ban | Install HTTP GET-DOS jail configuration"
      # Detects and bans IPs making excessive HTTP requests.
      # Thresholds: 300 requests in 300 seconds (5 minutes) = 10 min ban.
      # WARNING: May cause false positives on legitimate high-traffic sites.
      # Requires web server with access logs (Apache/Nginx).
      ansible.builtin.copy:
        content: |
          [http-get-dos]
          enabled = true
          port = http,https
          filter = http-get-dos
          logpath = /var/log/apache2/access.log
          maxretry = 300
          findtime = 300
          bantime = 600
        dest: /etc/fail2ban/jail.d/http-get-dos.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart fail2ban
      when: false  # Set to true to enable DDOS protection on web servers
  tags:
    - security
    - ddos
    - optional
    - web-protection 
# =============================================================================
# ADVANCED SECURITY FEATURES
# =============================================================================

# -----------------------------------------------------------------------------
# SECTION 6: Kernel Hardening (sysctl)
# -----------------------------------------------------------------------------
# Hardens kernel parameters to protect against network attacks and exploits.

- name: "Kernel Hardening | Apply sysctl security parameters"
  block:
    - name: "Kernel Security | Configure kernel parameters via sysctl"
      # Applies comprehensive kernel hardening settings.
      # Protects against: SYN floods, IP spoofing, ICMP attacks, etc.
      ansible.builtin.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_set: yes
      loop: "{{ kernel_hardening_settings | dict2items }}"
      when: enable_kernel_hardening | bool
      tags:
        - kernel
        - sysctl
  tags:
    - security
    - hardening
    - kernel-hardening

# -----------------------------------------------------------------------------
# SECTION 7: Unattended Security Upgrades
# -----------------------------------------------------------------------------
# Automatically installs security updates without manual intervention.

- name: "Auto Updates | Configure unattended security upgrades"
  block:
    - name: "Package Install | Install unattended-upgrades package"
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present

    - name: "Config | Enable automatic security updates"
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
          };
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::MinimalSteps "true";
          Unattended-Upgrade::InstallOnShutdown "false";
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "false";
          Unattended-Upgrade::Automatic-Reboot-Time "03:00";
        owner: root
        group: root
        mode: '0644'
  when: enable_unattended_upgrades | default(true) | bool
  tags:
    - security
    - auto-updates
    - unattended-upgrades

# -----------------------------------------------------------------------------
# SECTION 8: AppArmor Enforcement
# -----------------------------------------------------------------------------
# Enables and enforces AppArmor mandatory access control.

- name: "AppArmor | Configure AppArmor enforcement"
  block:
    - name: "Package Install | Ensure AppArmor is installed"
      ansible.builtin.apt:
        name:
          - apparmor
          - apparmor-utils
        state: present

    - name: "Service | Ensure AppArmor service is enabled and running"
      ansible.builtin.systemd:
        name: apparmor
        enabled: yes
        state: started

    - name: "Enforcement | Set all profiles to enforce mode"
      ansible.builtin.shell: aa-enforce /etc/apparmor.d/*
      when: apparmor_enforce_mode | bool
      changed_when: false
      failed_when: false
  when: enable_apparmor | bool
  tags:
    - security
    - apparmor
    - mac

# -----------------------------------------------------------------------------
# SECTION 9: Secure Shared Memory
# -----------------------------------------------------------------------------
# Prevents privilege escalation attacks via shared memory.

- name: "Shared Memory | Secure /dev/shm mount"
  block:
    - name: "Mount | Configure secure /dev/shm in /etc/fstab"
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "tmpfs /dev/shm tmpfs defaults,noexec,nodev,nosuid,size=2G 0 0"
        regexp: '^tmpfs\s+/dev/shm'
        state: present

    - name: "Remount | Apply secure mount options immediately"
      ansible.builtin.command: mount -o remount /dev/shm
      changed_when: false
  when: enable_secure_shm | bool
  tags:
    - security
    - hardening
    - shm

# -----------------------------------------------------------------------------
# SECTION 10: Lynis Security Auditing
# -----------------------------------------------------------------------------
# Installs Lynis for comprehensive security auditing.

- name: "Lynis | Install security auditing tool"
  block:
    - name: "Package Install | Install Lynis"
      ansible.builtin.apt:
        name: lynis
        state: present

    - name: "Audit | Run security audit (if enabled)"
      ansible.builtin.command: lynis audit system --quick
      register: lynis_output
      when: lynis_run_audit | bool
      changed_when: false

    - name: "Report | Display Lynis audit summary"
      ansible.builtin.debug:
        msg: "Lynis audit complete. Report: /var/log/lynis.log"
      when: lynis_run_audit | bool
  when: enable_lynis | bool
  tags:
    - security
    - audit
    - lynis

# -----------------------------------------------------------------------------
# SECTION 11: Rootkit Detection (rkhunter)
# -----------------------------------------------------------------------------
# Detects rootkits, backdoors, and local exploits.

- name: "Rootkit Detection | Configure rkhunter"
  block:
    - name: "Package Install | Install rkhunter"
      ansible.builtin.apt:
        name: rkhunter
        state: present

    - name: "Database | Update rkhunter database"
      ansible.builtin.command: rkhunter --update
      changed_when: false
      failed_when: false

    - name: "Baseline | Create initial file properties database"
      ansible.builtin.command: rkhunter --propupd
      args:
        creates: /var/lib/rkhunter/db/rkhunter.dat
      changed_when: false

    - name: "Cron | Schedule daily rootkit scans"
      ansible.builtin.cron:
        name: "rkhunter daily scan"
        hour: "3"
        minute: "30"
        job: "/usr/bin/rkhunter --cronjob --report-warnings-only 2>&1 | logger -t rkhunter"
        user: root
      when: rkhunter_cron_daily | bool
  when: enable_rkhunter | bool
  tags:
    - security
    - rootkit
    - rkhunter

# -----------------------------------------------------------------------------
# SECTION 12: File Integrity Monitoring (AIDE)
# -----------------------------------------------------------------------------
# Monitors file system for unauthorized changes.

- name: "File Integrity | Configure AIDE"
  block:
    - name: "Package Install | Install AIDE"
      ansible.builtin.apt:
        name: aide
        state: present

    - name: "Database | Check if AIDE database exists"
      ansible.builtin.stat:
        path: /var/lib/aide/aide.db
      register: aide_db

    - name: "Database | Initialize AIDE database"
      ansible.builtin.command: aideinit
      args:
        creates: /var/lib/aide/aide.db.new
      when: not aide_db.stat.exists

    - name: "Database | Move AIDE database to production location"
      ansible.builtin.command: mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
      args:
        removes: /var/lib/aide/aide.db.new
        creates: /var/lib/aide/aide.db
      when: not aide_db.stat.exists

    - name: "Cron | Schedule daily integrity checks"
      ansible.builtin.cron:
        name: "AIDE daily check"
        hour: "4"
        minute: "0"
        job: "/usr/bin/aide --check 2>&1 | logger -t aide"
        user: root
      when: aide_cron_daily | bool
  when: enable_aide | bool
  tags:
    - security
    - integrity
    - aide

# -----------------------------------------------------------------------------
# SECTION 13: Audit Logging (auditd)
# -----------------------------------------------------------------------------
# Comprehensive system call and security event logging.

- name: "Audit Logging | Configure auditd"
  block:
    - name: "Package Install | Install auditd"
      ansible.builtin.apt:
        name: auditd
        state: present

    - name: "Service | Enable and start auditd"
      ansible.builtin.systemd:
        name: auditd
        enabled: yes
        state: started

    - name: "Rules | Deploy audit rules"
      ansible.builtin.lineinfile:
        path: /etc/audit/rules.d/audit.rules
        line: "{{ item }}"
        create: yes
      loop: "{{ auditd_rules }}"
      notify: restart auditd

    - name: "Rules | Load audit rules"
      ansible.builtin.command: augenrules --load
      changed_when: false
  when: enable_auditd | bool
  tags:
    - security
    - audit
    - auditd

# -----------------------------------------------------------------------------
# SECTION 14: Log Monitoring (Logwatch)
# -----------------------------------------------------------------------------
# Daily log analysis and reporting.

- name: "Log Monitoring | Configure Logwatch"
  block:
    - name: "Package Install | Install Logwatch"
      ansible.builtin.apt:
        name: logwatch
        state: present

    - name: "Config | Configure Logwatch settings"
      ansible.builtin.copy:
        dest: /etc/logwatch/conf/logwatch.conf
        content: |
          Detail = {{ logwatch_detail }}
          MailTo = {{ logwatch_email if logwatch_email else 'root' }}
          Range = yesterday
          Service = All
        owner: root
        group: root
        mode: '0644'
  when: enable_logwatch | bool
  tags:
    - security
    - logging
    - logwatch

# -----------------------------------------------------------------------------
# SECTION 15: IPv6 Configuration
# -----------------------------------------------------------------------------
# Disables IPv6 if not needed to reduce attack surface.

- name: "IPv6 | Disable IPv6 (if configured)"
  block:
    - name: "Kernel | Disable IPv6 via sysctl"
      ansible.builtin.sysctl:
        name: "{{ item }}"
        value: "1"
        state: present
        reload: yes
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

    - name: "GRUB | Disable IPv6 in GRUB configuration"
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX='
        line: 'GRUB_CMDLINE_LINUX="ipv6.disable=1"'
      notify: update grub
  when: disable_ipv6 | bool
  tags:
    - security
    - network
    - ipv6

# -----------------------------------------------------------------------------
# SECTION 16: Two-Factor Authentication
# -----------------------------------------------------------------------------
# Configures Google Authenticator for SSH 2FA.

- name: "2FA | Configure SSH Two-Factor Authentication"
  block:
    - name: "Package Install | Install Google Authenticator PAM module"
      ansible.builtin.apt:
        name: libpam-google-authenticator
        state: present

    - name: "Config | Enable 2FA in SSH configuration"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        line: "ChallengeResponseAuthentication yes"
        regexp: '^#?ChallengeResponseAuthentication'
      notify: restart ssh

    - name: "PAM | Configure PAM for Google Authenticator"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/sshd
        line: "auth required pam_google_authenticator.so nullok"
        insertafter: "@include common-auth"

    - name: "Notice | Display 2FA setup instructions"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "2FA CONFIGURATION REQUIRED"
          - "=========================================="
          - "Each user must run: google-authenticator"
          - "Follow prompts to set up OTP"
          - "Scan QR code with authenticator app"
          - "Save emergency scratch codes"
          - "=========================================="
  when: enable_ssh_2fa | bool
  tags:
    - security
    - ssh
    - 2fa

# -----------------------------------------------------------------------------
# SECTION 17: Automated Backups
# -----------------------------------------------------------------------------
# Configures automated system backups.

- name: "Backups | Configure automated backup system"
  block:
    - name: "Directory | Create backup destination"
      ansible.builtin.file:
        path: "{{ backup_destination }}"
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: "Script | Deploy backup script"
      ansible.builtin.template:
        src: backup_script.sh.j2
        dest: /usr/local/bin/system_backup.sh
        mode: '0700'
        owner: root
        group: root

    - name: "Cron | Schedule automated backups"
      ansible.builtin.cron:
        name: "Automated system backup"
        minute: "{{ backup_schedule.split()[0] }}"
        hour: "{{ backup_schedule.split()[1] }}"
        job: "/usr/local/bin/system_backup.sh 2>&1 | logger -t backup"
        user: root
  when: enable_backups | bool
  tags:
    - security
    - backup
    - recovery

# -----------------------------------------------------------------------------
# SECTION 18: USB Restrictions
# -----------------------------------------------------------------------------
# Blocks USB storage devices to prevent data exfiltration.

- name: "USB Security | Restrict USB storage devices"
  block:
    - name: "Blacklist | Block usb-storage kernel module"
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-usb-storage.conf
        content: |
          # Block USB storage devices
          blacklist usb-storage
        owner: root
        group: root
        mode: '0644'

    - name: "Kernel | Unload usb-storage module if loaded"
      ansible.builtin.command: rmmod usb-storage
      failed_when: false
      changed_when: false
  when: enable_usb_restrictions | bool
  tags:
    - security
    - usb
    - restrictions

# -----------------------------------------------------------------------------
# SECTION 19: Network Intrusion Detection (Suricata)
# -----------------------------------------------------------------------------
# Deploys Suricata IDS for network threat detection.

- name: "IDS | Configure Suricata Network Intrusion Detection"
  block:
    - name: "Package Install | Install Suricata"
      ansible.builtin.apt:
        name:
          - suricata
          - suricata-update
        state: present

    - name: "Config | Configure Suricata interface"
      ansible.builtin.lineinfile:
        path: /etc/suricata/suricata.yaml
        regexp: '^\s+- interface:'
        line: "    - interface: {{ suricata_interface }}"

    - name: "Rules | Check if Suricata rules exist"
      ansible.builtin.stat:
        path: /var/lib/suricata/rules/suricata.rules
      register: suricata_rules

    - name: "Rules | Update Suricata rulesets"
      ansible.builtin.command: suricata-update
      changed_when: false
      when: not suricata_rules.stat.exists

    - name: "Service | Enable and start Suricata"
      ansible.builtin.systemd:
        name: suricata
        enabled: yes
        state: started
  when: enable_suricata | bool
  tags:
    - security
    - ids
    - suricata
    - network

