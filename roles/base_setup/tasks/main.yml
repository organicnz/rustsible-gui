---
# =============================================================================
# BASE SYSTEM SETUP ROLE
# =============================================================================
# Purpose: Initial server configuration including user management, package
#          installation, timezone configuration, and system initialization
#
# Selectable Tags:
#   - connection  : System connection and availability checks
#   - cloud-init  : Cloud initialization tasks
#   - timezone    : Timezone configuration
#   - user        : User creation and management
#   - sudo        : Sudo and privilege escalation setup
#   - ssh-keys    : SSH key deployment
#   - packages    : Package installation and updates
#   - upgrade     : System version upgrades
# =============================================================================

# -----------------------------------------------------------------------------
# SECTION 1: System Availability and Initialization
# -----------------------------------------------------------------------------
# Ensures the target system is reachable and ready for configuration.
# This prevents playbook failures due to system boot delays or cloud-init processes.

- name: "System Check | Wait for system to become reachable"
  ansible.builtin.wait_for_connection:
    timeout: 600
  tags:
    - always
    - connection

- name: "System Check | Wait for cloud-init to complete"
  # Cloud-init can interfere with package management and system configuration.
  # This ensures cloud-init has finished before we proceed with our tasks.
  command: cloud-init status --wait
  changed_when: false
  retries: 10
  delay: 10
  until: result.stdout == "done"
  register: result
  when: false  # Set to true if using cloud providers (AWS, Azure, DigitalOcean, etc.)
  tags:
    - system
    - cloud-init
    - connection

# -----------------------------------------------------------------------------
# SECTION 2: System Configuration
# -----------------------------------------------------------------------------
# Basic system settings that should be applied early in the setup process.

- name: "System Config | Set timezone to {{ system_timezone | default('America/Los_Angeles') }}"
  # Setting timezone prevents logging and scheduling issues.
  # Ensures consistency across distributed systems.
  community.general.timezone:
    name: "{{ system_timezone | default('America/Los_Angeles') }}"
  tags:
    - system
    - timezone
    - config

- name: "System Config | Set hostname to {{ server_hostname }}"
  # Sets the system hostname for identification and network purposes.
  # Hostname is visible in shell prompts and network connections.
  ansible.builtin.hostname:
    name: "{{ server_hostname }}"
  when: server_hostname is defined and server_hostname != ''
  tags:
    - system
    - hostname
    - config

- name: "System Config | Update /etc/hosts with new hostname"
  # Ensures hostname resolves locally to prevent DNS lookup issues.
  # Critical for many applications that rely on hostname resolution.
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ server_hostname }}"
    state: present
  when: server_hostname is defined and server_hostname != ''
  tags:
    - system
    - hostname
    - config

# -----------------------------------------------------------------------------
# SECTION 3: User and Access Management
# -----------------------------------------------------------------------------
# Creates non-root user with sudo privileges for secure system administration.
# Implements principle of least privilege by using wheel group for sudo access.

- name: "User Management | Create 'wheel' group for sudo access"
  # The wheel group is a standard Unix convention for users with sudo privileges.
  # This provides better organization than adding users individually to sudoers.
  ansible.builtin.group:
    name: wheel
    state: present
  tags:
    - user
    - security
    - sudo
    - groups

- name: "User Management | Configure passwordless sudo for wheel group"
  # Passwordless sudo is acceptable when combined with SSH key authentication.
  # This enables automation while maintaining security through key-based access.
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^(%wheel|%@includedir)'
    line: '%wheel ALL=(ALL:ALL) NOPASSWD: ALL'
    validate: '/usr/sbin/visudo -cf %s'
  tags:
    - user
    - security
    - sudo

- name: "User Management | Create non-root user '{{ added_user }}' with sudo privileges"
  # Creates the primary administrative user account.
  # Replaces direct root login with a named user for better auditability.
  ansible.builtin.user:
    name: "{{ added_user }}"
    state: present
    groups: wheel
    append: true
    create_home: true
    shell: /bin/bash
  tags:
    - user
    - create-user

- name: "User Management | Deploy SSH public key for {{ added_user }}"
  # SSH key-based authentication is more secure than password authentication.
  # Prevents brute-force attacks and enables passwordless automation.
  ansible.builtin.authorized_key:
    user: "{{ added_user }}"
    state: present
    key: "{{ copy_local_key }}"
  tags:
    - user
    - security
    - ssh-keys

- name: "User Management | Set secure password for {{ added_user }}"
  # Backup authentication method in case SSH keys are unavailable.
  # Password is stored as SHA-512 hash for security.
  ansible.builtin.user:
    name: "{{ added_user }}"
    state: present
    password: "{{ user_password | password_hash('sha512') }}"
  tags:
    - user
    - security
    - password

- name: "User Management | Add {{ added_user }} to sudoers with NOPASSWD"
  # Redundant sudo configuration for compatibility with different Linux distributions.
  # Ensures user has sudo access even if wheel group method doesn't work.
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: "{{ added_user }} ALL"
    line: "{{ added_user }} ALL = (ALL) NOPASSWD: ALL"
    state: present
    validate: '/usr/sbin/visudo -cf %s'
  tags:
    - user
    - security
    - sudo

# -----------------------------------------------------------------------------
# SECTION 4: Package Management and System Updates
# -----------------------------------------------------------------------------
# Installs essential packages and applies system updates for security and stability.

- name: "Package Management | Refresh apt package cache"
  # Fresh package cache ensures we install the latest available versions.
  # Cache is valid for 1 hour to avoid excessive repository queries.
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - system
    - packages
    - apt-cache

- name: "Package Management | Install essential system packages"
  # Installs packages defined in vars/default.yml under 'sys_packages'.
  # These typically include vim, curl, git, htop, and other admin tools.
  ansible.builtin.apt:
    name: "{{ sys_packages }}"
    state: latest
    update_cache: yes
  tags:
    - system
    - packages
    - install

- name: "Package Management | Upgrade all installed packages to latest versions"
  # Applies all available security and feature updates.
  # Critical for maintaining system security posture.
  ansible.builtin.apt:
    name: "*"
    state: latest
  tags:
    - system
    - packages
    - upgrade
    - security

- name: "Package Management | Clean package cache and remove orphaned dependencies"
  # Frees disk space by removing obsolete packages and cached .deb files.
  # Removes dependencies that are no longer needed by any installed package.
  tags:
    - system
    - packages
  block:
    - name: "Package Cleanup | Remove cached package files"
      ansible.builtin.apt:
        autoclean: yes

    - name: "Package Cleanup | Remove orphaned dependencies"
      ansible.builtin.apt:
        autoremove: yes

# -----------------------------------------------------------------------------
# SECTION 5: Distribution Upgrade Management
# -----------------------------------------------------------------------------
# Handles Ubuntu version-specific configurations and EOL notices.

- name: "System Upgrade | Check and prepare for distribution upgrades"
  tags:
    - system
    - upgrade
    - version-check
    - eol
  block:
    - name: "System Info | Display current Ubuntu version"
      ansible.builtin.debug:
        msg: 'This server is running Ubuntu {{ ansible_distribution_version }}'

    - name: "EOL Cleanup | Remove end-of-life MOTD warnings"
      # Removes Ubuntu ESM (Extended Security Maintenance) notices.
      # Only applicable for Ubuntu versions reaching end-of-life.
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /etc/update-motd.d/99-esm
        - /run/motd.dynamic
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '23.10'

    - name: "Upgrade Tools | Ensure update-manager-core is installed"
      # Required for do-release-upgrade command.
      # Enables automated distribution upgrades when needed.
      ansible.builtin.apt:
        name: update-manager-core
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '23.10' 