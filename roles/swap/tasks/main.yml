---
# =============================================================================
# SWAP SPACE CONFIGURATION ROLE
# =============================================================================
# Purpose: Intelligently configure swap space based on available system RAM
#          to optimize memory management and prevent OOM situations
#
# Intelligent Sizing Algorithm:
#   - Systems with <2GB RAM:  Swap = 2x RAM (handles high memory pressure)
#   - Systems with 2-4GB RAM: Swap = 1.5x RAM (balanced approach)
#   - Systems with 4-8GB RAM: Swap = 1x RAM (minimal swap usage)
#   - Systems with 8GB+ RAM:  Swap = 1x RAM (primarily for hibernation)
#
# Selectable Tags:
#   - swap            : All swap-related tasks
#   - swap-info       : Display system memory and swap information
#   - swap-calculate  : Calculate appropriate swap size
#   - swap-create     : Create swap file
#   - swap-configure  : Configure swap parameters (swappiness, cache pressure)
#   - swap-enable     : Enable swap and add to fstab
#   - swap-optimize   : Optimize swap performance parameters
# =============================================================================

# -----------------------------------------------------------------------------
# SECTION 1: System Memory Analysis
# -----------------------------------------------------------------------------
# Analyzes system memory to determine appropriate swap size.

- name: "Memory Analysis | Calculate total memory in MB and GB"
  ansible.builtin.set_fact:
    mem_total_mb: "{{ (ansible_memtotal_mb | int) }}"
    mem_total_gb: "{{ (ansible_memtotal_mb | int) // 1024 }}"
  tags:
    - swap
    - swap-calculate
    - swap-info

- name: "Memory Analysis | Calculate appropriate swap size using intelligent algorithm"
  # Improved precision: Use MB for calculation to handle small systems correctly.
  # - Systems with <2GB RAM:  2x RAM
  # - Systems with 2-4GB RAM: 1.5x RAM
  # - Systems with 4GB+ RAM:   1x RAM
  # - Minimum swap: 1024 MB (1GB)
  ansible.builtin.set_fact:
    swap_size_mb: >-
      {{
        [(
          (mem_total_mb | int * 2) if (mem_total_mb | int) < 2048 else
          (mem_total_mb | int * 1.5) | round(0) | int if (mem_total_mb | int) < 4096 else
          (mem_total_mb | int)
        ), 1024] | max
      }}
  tags:
    - swap
    - swap-calculate

# -----------------------------------------------------------------------------
# SECTION 2: Swap File Status Check
# -----------------------------------------------------------------------------
# Checks if swap file exists and determines if resize is needed.

- name: "Swap Status | Check if swap file already exists at /swapfile"
  ansible.builtin.stat:
    path: /swapfile
  register: swap_file_check
  tags:
    - swap
    - swap-info

- name: "Swap Status | Get current swap file size in MB"
  ansible.builtin.set_fact:
    current_swap_size_mb: "{{ (swap_file_check.stat.size / 1048576) | int if swap_file_check.stat.exists else 0 }}"
  tags:
    - swap
    - swap-info

- name: "Swap Status | Check if swap is currently active"
  command: swapon -s
  register: swap_active
  changed_when: false
  tags:
    - swap
    - swap-info

- name: "Swap Info | Display swap configuration details and planned actions"
  ansible.builtin.debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "SWAP CONFIGURATION ANALYSIS"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "System Memory: {{ mem_total_mb }} MB"
      - "Calculated Swap Size: {{ swap_size_mb }} MB"
      - "{% if swap_file_check.stat.exists %}Current Swap File: {{ current_swap_size_mb }} MB{% else %}No existing swap file found{% endif %}"
      - "Swap Status: {% if swap_active.stdout.find('/swapfile') != -1 %}ACTIVE{% else %}INACTIVE{% endif %}"
      - "Action: {% if current_swap_size_mb | int != swap_size_mb | int or current_swap_size_mb | int == 0 %}RESIZE/CREATE (target: {{ swap_size_mb }} MB){% else %}KEEP (correct size exists){% endif %}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  tags:
    - swap
    - swap-info

# -----------------------------------------------------------------------------
# SECTION 3: Swap Space Configuration
# -----------------------------------------------------------------------------
# Creates or resizes swap file and configures system parameters.

- name: "Swap Configuration | Complete swap setup with error handling"
  block:
    - name: "Swap Disable | Turn off existing swap before modification"
      command: swapoff /swapfile
      when:
        - swap_file_check.stat.exists
        - swap_active.stdout.find('/swapfile') != -1
        - (current_swap_size_mb | int != swap_size_mb | int or current_swap_size_mb | int == 0)
      tags:
        - swap-create

    - name: "Swap Cleanup | Remove existing swap file for resize"
      ansible.builtin.file:
        path: /swapfile
        state: absent
      when:
        - swap_file_check.stat.exists
        - (current_swap_size_mb | int != swap_size_mb | int or current_swap_size_mb | int == 0)
      tags:
        - swap-create

    - name: "Swap Creation | Allocate swap file using dd command"
      command: "dd if=/dev/zero of=/swapfile bs=1M count={{ swap_size_mb }}"
      register: swap_file_created
      when:
        - current_swap_size_mb | int != swap_size_mb | int or current_swap_size_mb | int == 0
      tags:
        - swap-create

    - name: "Swap Security | Set restrictive permissions on swap file"
      ansible.builtin.file:
        path: /swapfile
        mode: '0600'
        owner: root
        group: root
      tags:
        - swap-create
        - security

    - name: "Swap Format | Initialize swap area on file"
      # Always format if we just created it or if it exists but isn't active.
      # This fixes the 'read swap header failed' error.
      command: mkswap /swapfile
      when: swap_file_created is changed or swap_active.stdout.find('/swapfile') == -1
      tags:
        - swap-create

    - name: "Swap Activation | Enable swap file for immediate use"
      command: swapon /swapfile
      when: swap_active.stdout.find('/swapfile') == -1
      tags:
        - swap-enable

    - name: "Swap Persistence | Add swap to /etc/fstab for boot persistence"
      # Ensures swap is activated automatically on system boot.
      # Uses regexp to prevent duplicate entries.
      # Format: device mountpoint type options dump pass
      # defaults: Uses default mount options
      # 0 0: No dump, no fsck (swap doesn't need filesystem check)
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "/swapfile swap swap defaults 0 0"
        state: present
        regexp: "^/swapfile"
      tags:
        - swap-enable
        - swap-configure

    - name: "Swap Optimization | Set swappiness to 10 for optimal performance"
      # Controls how aggressively kernel swaps memory to disk.
      # Default: 60 (swaps relatively aggressively)
      # Setting: 10 (only swap when necessary, prefer RAM)
      # Recommended for:
      # - Systems with adequate RAM
      # - Desktop/server workloads
      # - Better application performance
      # Lower values = less swapping = better performance (when RAM available)
      ansible.builtin.sysctl:
        name: vm.swappiness
        value: "10"
        state: present
        reload: yes
      tags:
        - swap-configure
        - swap-optimize
        - performance

    - name: "Swap Optimization | Set cache pressure to 50 for balanced caching"
      # Controls tendency to reclaim memory used for caching directory/inode objects.
      # Default: 100 (balanced)
      # Setting: 50 (favor retaining cache)
      # Benefits:
      # - Improves filesystem metadata access speed
      # - Better performance for file-heavy workloads
      # - Reduces disk I/O for repeated file operations
      # Lower values = kernel prefers to retain cache = faster file access
      ansible.builtin.sysctl:
        name: vm.vfs_cache_pressure
        value: "50"
        state: present
        reload: yes
      tags:
        - swap-configure
        - swap-optimize
        - performance

  rescue:
    # -------------------------------------------------------------------------
    # Error Handling
    # -------------------------------------------------------------------------
    # Provides helpful troubleshooting information on failure.

    - name: "Error Handler | Display swap setup failure message"
      ansible.builtin.debug:
        msg: |
          ============================================================
          SWAP CONFIGURATION FAILED
          ============================================================

          Possible causes:
          - Insufficient disk space (need {{ swap_size_gb }} GB free)
          - Permission issues (requires root access)
          - Filesystem doesn't support swap files (rare)
          - Existing swap is locked by another process

          Troubleshooting steps:
          1. Check available disk space: df -h /
          2. Verify no swap conflicts: swapon -s
          3. Check system logs: journalctl -xe
          4. Manually disable swap if needed: swapoff -a

          ============================================================

  tags:
    - swap
    - system
