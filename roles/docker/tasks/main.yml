---
# =============================================================================
# DOCKER INSTALLATION AND CONFIGURATION ROLE
# =============================================================================
# Purpose: Install Docker CE, Docker Compose, and configure secure Docker daemon
#          with comprehensive error handling and repository conflict resolution
#
# Selectable Tags:
#   - docker          : All Docker-related tasks
#   - docker-deps     : Install Docker dependencies only
#   - docker-cleanup  : Clean existing Docker repository configurations
#   - docker-repo     : Configure Docker repository
#   - docker-install  : Install Docker packages
#   - docker-compose  : Install Docker Compose
#   - docker-service  : Manage Docker service
#   - docker-python   : Install Python Docker module
#   - docker-users    : Add users to docker group
#   - docker-security : Apply Docker security configurations
#   - docker-daemon   : Docker daemon configuration
#   - verify          : Verification and health checks
# =============================================================================

- name: "Docker Check | Display installation status"
  ansible.builtin.debug:
    msg: "Docker installation is {{ 'enabled' if install_docker else 'disabled' }}"
  tags:
    - docker
    - always

- name: "Docker Installation | Complete Docker setup with error handling"
  block:
    # -------------------------------------------------------------------------
    # SECTION 1: Prerequisites and Dependencies
    # -------------------------------------------------------------------------
    # Installs packages required for Docker repository setup and functionality.

    - name: "Docker Prerequisites | Install required system packages"
      ansible.builtin.apt:
        pkg:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - python3-pip
        state: present
        update_cache: true
        cache_valid_time: 3600
      tags:
        - docker-deps
        - packages

    - name: "Docker Check | Test if Docker is already installed"
      ansible.builtin.command: docker --version
      register: docker_installed
      changed_when: false
      failed_when: false
      tags:
        - docker-cleanup
        - docker-repo

    # -------------------------------------------------------------------------
    # SECTION 2: Repository Conflict Resolution (first install only)
    # -------------------------------------------------------------------------
    # Only cleans up old Docker repo configs on first install.
    # Skipped entirely when Docker is already working.

    - name: "Docker Cleanup | Remove stale Docker GPG key files"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/trusted.gpg.d/docker.gpg
        - /etc/apt/keyrings/docker.gpg
        - /usr/share/keyrings/docker-archive-keyring.gpg
      when: docker_installed.rc != 0
      tags:
        - docker-cleanup
        - repo-cleanup

    - name: "Docker Cleanup | Find existing Docker repository files"
      ansible.builtin.find:
        paths: /etc/apt/sources.list.d
        patterns: "*docker*.list"
      register: docker_repo_files
      when: docker_installed.rc != 0
      tags:
        - docker-cleanup
        - repo-cleanup

    - name: "Docker Cleanup | Remove old Docker repository files"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ docker_repo_files.files | default([]) }}"
      when: docker_installed.rc != 0
      tags:
        - docker-cleanup
        - repo-cleanup

    - name: "Docker Cleanup | Remove Docker entries from main sources.list"
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        regexp: .*download.docker.com.*
        state: absent
      when: docker_installed.rc != 0
      tags:
        - docker-cleanup
        - repo-cleanup

    # -------------------------------------------------------------------------
    # SECTION 3: Docker Repository Configuration
    # -------------------------------------------------------------------------
    # Sets up official Docker repository with GPG key verification.
    # Uses modern signed-by approach to avoid deprecated apt-key warnings.

    - name: "Docker Repository | Create keyrings directory"
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      when: docker_installed.rc != 0
      tags:
        - docker-repo
        - gpg-setup

    - name: "Docker Repository | Download Docker GPG key"
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
      when: docker_installed.rc != 0
      tags:
        - docker-repo
        - gpg-key

    - name: "Docker Repository | Clean apt cache to prevent conflicts"
      command: apt-get clean
      changed_when: false
      when: docker_installed.rc != 0
      tags:
        - docker-repo
        - cache-cleanup

    - name: "Docker Repository | Detect system architecture for Docker repo"
      ansible.builtin.set_fact:
        docker_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"
      tags:
        - docker-repo

    - name: "Docker Repository | Add Docker APT repository with GPG verification"
      apt_repository:
        repo: "deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
        update_cache: yes
      when: docker_installed.rc != 0
      tags:
        - docker-repo
        - apt-source

    # -------------------------------------------------------------------------
    # SECTION 4: Docker Engine Installation
    # -------------------------------------------------------------------------
    # Installs Docker Engine and core components.

    - name: "Docker Installation | Install Docker Engine packages"
      ansible.builtin.apt:
        pkg:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: true
        cache_valid_time: 3600
      tags:
        - docker-install
        - packages

    # -------------------------------------------------------------------------
    # SECTION 5: User and Group Management
    # -------------------------------------------------------------------------
    # Configures Docker group and user permissions.

    - name: "Docker Users | Ensure docker group exists"
      # Creates docker group if it doesn't exist.
      # Required for granting Docker access to non-root users.
      ansible.builtin.group:
        name: docker
        state: present
      tags:
        - docker-users
        - groups
        - security

    - name: "Docker Users | Add specified users to docker group"
      # Grants users permission to run Docker commands without sudo.
      # WARNING: Members of docker group have root-equivalent access!
      # They can mount host filesystem in containers and escape to root.
      # Only add trusted users who already have sudo access.
      # Users defined in vars/default.yml under 'docker_users' list.
      ansible.builtin.user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users | default([]) }}"
      tags:
        - docker-users
        - user-groups
        - security

    # -------------------------------------------------------------------------
    # SECTION 6: Docker Compose Installation
    # -------------------------------------------------------------------------
    # Installs Docker Compose for multi-container applications.

    - name: "Docker Compose | Check if docker-compose is already installed"
      ansible.builtin.stat:
        path: /usr/local/bin/docker-compose
      register: compose_binary
      tags:
        - docker-compose

    - name: "Docker Compose | Detect compose architecture"
      ansible.builtin.set_fact:
        compose_arch: "{{ 'aarch64' if ansible_architecture == 'aarch64' else 'x86_64' }}"
      when: not compose_binary.stat.exists
      tags:
        - docker-compose

    - name: "Docker Compose | Install specific version of Docker Compose"
      ansible.builtin.get_url:
        url: "https://github.com/docker/compose/releases/{{ docker_compose_version }}/download/docker-compose-Linux-{{ compose_arch }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      when:
        - not compose_binary.stat.exists
        - docker_compose_version is defined and docker_compose_version != "latest"
      tags:
        - docker-compose
        - compose-install

    - name: "Docker Compose | Install latest Docker Compose"
      ansible.builtin.get_url:
        url: "https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-{{ compose_arch }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      when:
        - not compose_binary.stat.exists
        - docker_compose_version is not defined or docker_compose_version == "latest"
      tags:
        - docker-compose
        - compose-install

    # -------------------------------------------------------------------------
    # SECTION 7: Python Docker Module
    # -------------------------------------------------------------------------
    # Installs Python Docker SDK for Ansible Docker modules.

    - name: "Docker Python | Attempt installation via apt package"
      # First tries to install python3-docker from Ubuntu repositories.
      # Preferred method when available - uses system package management.
      # May not be available on all Ubuntu versions.
      ansible.builtin.apt:
        name: python3-docker
        state: present
      tags:
        - docker-python
        - python-modules
        - packages

    - name: "Docker Python | Install Docker SDK via pip for Ubuntu 24.04+"
      # Fallback: Install docker-py via pip with --break-system-packages.
      # Required for Ubuntu 24.04+ due to PEP 668 (externally managed environments).
      # Without this flag, pip refuses to install in system Python environment.
      # failed_when: false - Don't fail if apt installation succeeded above.
      pip:
        name: docker
        extra_args: --break-system-packages
      when: ansible_distribution_version is version('24.04', '>=')
      failed_when: false
      tags:
        - docker-python
        - python-modules
        - pip-install

    # -------------------------------------------------------------------------
    # SECTION 8: Docker Daemon Security Configuration
    # -------------------------------------------------------------------------
    # Applies security hardening to Docker daemon.

    - name: "Docker Security | Ensure Docker daemon directory exists"
      # Creates /etc/docker directory if it doesn't exist.
      # Required for daemon.json configuration file.
      ansible.builtin.file:
        path: /etc/docker
        state: directory
        mode: '0755'
      tags:
        - docker-daemon
        - docker-security

    - name: "Docker Security | Configure Docker daemon with hardening settings"
      # Applies production-ready Docker daemon configuration:
      #
      # Logging:
      # - log-driver: json-file - Structured logging for container output
      # - max-size: 10m - Limit individual log file size to 10MB
      # - max-file: 3 - Keep only 3 rotated log files (30MB total per container)
      #
      # Reliability:
      # - live-restore: true - Keep containers running during daemon downtime/upgrades
      #
      # Security:
      # - userland-proxy: false - Use iptables for port forwarding (more efficient, less attack surface)
      # - no-new-privileges: true - Prevent containers from gaining additional privileges
      #
      # Additional recommended settings (not included):
      # - "icc": false - Disable inter-container communication by default
      # - "userns-remap": "default" - Enable user namespace remapping for stronger isolation
      ansible.builtin.copy:
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "live-restore": true,
            "userland-proxy": false,
            "no-new-privileges": true
          }
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: '0644'
      notify: restart docker
      tags:
        - docker-daemon
        - docker-security
        - security

    # -------------------------------------------------------------------------
    # SECTION 9: Docker Service Management
    # -------------------------------------------------------------------------
    # Starts Docker daemon and enables it to start on boot.

    - name: "Docker Service | Start and enable Docker daemon"
      # Ensures Docker service:
      # - Starts immediately (state: started)
      # - Starts automatically on system boot (enabled: yes)
      # Essential for container orchestration and automation.
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      tags:
        - docker-service
        - service-management

    # -------------------------------------------------------------------------
    # SECTION 10: Installation Verification
    # -------------------------------------------------------------------------
    # Validates Docker installation and displays version information.

    - name: "Docker Verification | Check Docker is running and accessible"
      # Runs 'docker info' to verify Docker daemon is operational.
      # This command requires Docker daemon to be running and accessible.
      # ignore_errors: Don't fail playbook if verification fails.
      command: docker info
      register: docker_info
      changed_when: false
      ignore_errors: true
      tags:
        - verify
        - health-check

    - name: "Docker Verification | Display Docker version and status"
      # Shows first line of docker info output (version and status).
      # Only displays if docker info command succeeded.
      ansible.builtin.debug:
        msg: "Docker is running successfully: {{ docker_info.stdout_lines[0] }}"
      when: docker_info.rc == 0
      tags:
        - verify
        - health-check

  when: install_docker | bool

  rescue:
    # -------------------------------------------------------------------------
    # Error Handling and Troubleshooting
    # -------------------------------------------------------------------------
    # Provides helpful error messages and manual recovery instructions.

    - name: "Error Handler | Display installation failure message"
      ansible.builtin.debug:
        msg: Failed to install Docker. Please check the error output above for details.

    - name: "Error Handler | Provide manual cleanup instructions"
      ansible.builtin.debug:
        msg: |

          ============================================================
          DOCKER INSTALLATION FAILED - MANUAL RECOVERY STEPS
          ============================================================

          If this is a repository conflict error, try these steps:

          1. Remove Docker entries from sources.list:
             sudo sed -i '/download.docker.com/d' /etc/apt/sources.list

          2. Remove all Docker repository files:
             sudo rm -f /etc/apt/sources.list.d/*docker*.list

          3. Remove all Docker GPG keys:
             sudo rm -f /etc/apt/trusted.gpg.d/docker.gpg
             sudo rm -f /etc/apt/keyrings/docker*
             sudo rm -f /usr/share/keyrings/docker*

          4. Clean and update apt:
             sudo apt-get clean
             sudo apt-get update

          5. Re-run this playbook:
             ansible-playbook playbook.yml -t docker -l webservers

          For other errors, check:
          - Network connectivity to download.docker.com
          - Ubuntu version compatibility
          - Available disk space (df -h)
          - Apt logs: /var/log/apt/history.log

          ============================================================

  tags:
    - docker
