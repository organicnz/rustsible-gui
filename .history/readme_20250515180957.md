# Improved Ansible Server Setup for Ubuntu

This Ansible playbook implements a comprehensive server setup for Ubuntu 23.04 systems with security hardening, fail2ban configuration, and optional Docker installation.

## Features

- **Modular Role Structure**: Organized into specialized roles for better maintainability
- **Enhanced Security**:
  - SSH hardening with configurable options (disable root login, password authentication)
  - UFW firewall with flexible port configuration
  - Improved fail2ban settings with longer ban times
  - System hardening best practices
- **Docker Installation**: Optional Docker and Docker Compose setup with security best practices
- **User Management**: Creates a non-root user with sudo privileges and SSH key authentication
- **Flexible Configuration**: All major settings configurable via variables
- **Reboot Management**: Handles required reboots safely
- **Comprehensive Tagging**: Allows running specific parts of the playbook

## Settings

All settings are configurable in `vars/default.yml`:

- `added_user`: The name of the remote sudo user to create
- `copy_local_key`: Path to a local SSH public key for the new user
- `ssh_port`: SSH port (default: 22)
- `disable_root_login`: Whether to disable root login via SSH (default: true)
- `password_authentication`: Whether to allow password authentication (default: false)
- `ufw_allowed_ports`: List of ports to open in the firewall
- `fail2ban_*`: Fail2ban configuration options
- `install_docker`: Whether to install Docker (default: true)
- `docker_users`: List of users to add to the Docker group

## Usage

### 1. Clone the Repository

```shell
git clone https://gitlab.com/organicnz/ansible-ubuntu-2304.git
cd ansible-ubuntu-2304
```

### 2. Customize the Variables

```shell
nano vars/default.yml
```

Adjust the settings according to your requirements.

### 3. Run the Main Playbook

For initial setup with root access:
```bash
ansible-playbook main_playbook.yml -l webservers -i inventory.ini -u root -k
```

After initial setup (with the non-root user):
```bash
ansible-playbook main_playbook.yml -l webservers -i inventory.ini -u organic --ask-become-pass
```

### 4. Run Selective Parts with Tags

Only run security-related tasks:
```bash
ansible-playbook main_playbook.yml -t security -l webservers -i inventory.ini -u organic --ask-become-pass
```

Only run Docker installation:
```bash
ansible-playbook main_playbook.yml -t docker -l webservers -i inventory.ini -u organic --ask-become-pass
```

## Troubleshooting

### SSH Connection Issues

If you encounter SSH connection issues, ensure your key is added to the SSH agent:

```bash
eval 'ssh-agent' && ssh-add ~/.ssh/azure_id_rsa.pem
```

### Checking Role Syntax

Validate the syntax of the playbook:

```bash
ansible-playbook main_playbook.yml --syntax-check
```

### Dry Run Mode

Test changes without applying them:

```bash
ansible-playbook main_playbook.yml -l webservers -i inventory.ini -u organic --ask-become-pass --check
```

## Directory Structure

```
ansible-ubuntu-2304/
├── main_playbook.yml   # Main playbook file
├── vars/
│   └── default.yml     # Default variables
├── inventory.ini       # Inventory file
├── ansible.cfg         # Ansible configuration
├── roles/
│   ├── base_setup/     # Base system setup role
│   ├── security/       # Security hardening role
│   ├── docker/         # Docker installation role
│   └── oefenweb.fail2ban/ # External role for fail2ban
└── readme.md           # This file
```

Based on the [DigitalOcean guide](https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-automate-initial-server-setup-on-ubuntu-20-04) but significantly enhanced with best practices and modern Ansible features.