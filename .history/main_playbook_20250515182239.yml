---
# Main Playbook for Ubuntu Server Setup
# This is a modular playbook that sets up an Ubuntu 23.04 server with security hardening
# and optional Docker installation

- hosts: all
  become: true
  vars_files:
    - vars/default.yml
  
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - always
    
    - name: Display playbook execution information
      debug:
        msg: "Running playbook for {{ ansible_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})"
      tags:
        - always
        
    - name: Ensure fail2ban is installed
      apt:
        name: fail2ban
        state: present
      tags:
        - security
        - fail2ban
  
  roles:
    # Base system setup (users, packages, etc.)
    - role: base_setup
      tags:
        - base
        - setup
    
    # Security hardening (SSH, firewall, fail2ban)
    - role: security
      tags:
        - security
    
    # Existing fail2ban role (external)
    - role: oefenweb.fail2ban
      tags:
        - security
        - fail2ban
      vars:
        fail2ban_ignoreips:
          - "{{ ansible_lo['ipv4']['address'] }}/8"
          - "{{ ansible_default_ipv4['address'] }}"
          - "{{ address }}"
        fail2ban_bantime: 86400  # 24 hours (direct value)
        fail2ban_findtime: 600   # 10 minutes (direct value)
        fail2ban_services:
          - name: "{{ fail2ban_ssh_service_name }}"
            maxretry: 3  # Direct value
            ignoreip:
              - "{{ ansible_lo['ipv4']['address'] }}/8"
              - "{{ ansible_default_ipv4['address'] }}"
              - "{{ address }}"
          - name: "{{ fail2ban_ssh_service_name }}-ddos"
            maxretry: 3  # Direct value
            ignoreip:
              - "{{ ansible_lo['ipv4']['address'] }}/8"
              - "{{ ansible_default_ipv4['address'] }}"
              - "{{ address }}"
    
    # Docker installation (optional)
    - role: docker
      tags:
        - docker
      when: install_docker | bool
  
  post_tasks:
    - name: Check if reboot is required
      register: reboot_required_file
      stat:
        path: /var/run/reboot-required
      tags:
        - always
    
    - name: Reboot if required
      reboot:
        msg: "Reboot initiated by Ansible due to kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
      when: reboot_required_file.stat.exists
      tags:
        - never
        - reboot
    
    - name: Final system info
      debug:
        msg: "Setup complete! System is ready."
      tags:
        - always 